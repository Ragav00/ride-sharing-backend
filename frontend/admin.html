<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ride Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .login-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 50px auto;
        }

        .dashboard {
            display: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #666;
            margin-top: 10px;
        }

        .section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-pending { background: #f39c12; }
        .status-assigned { background: #3498db; }
        .status-accepted { background: #2ecc71; }
        .status-in_progress { background: #9b59b6; }
        .status-completed { background: #27ae60; }
        .status-cancelled { background: #e74c3c; }

        .available { color: #27ae60; font-weight: bold; }
        .unavailable { color: #e74c3c; font-weight: bold; }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .btn {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-refresh {
            background: #27ae60;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .btn-refresh:hover {
            background: #229954;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .error {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .success {
            color: #27ae60;
            background: #f2fdf2;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            user-select: none;
        }

        .tab:hover {
            background-color: #f8f9fa;
            color: #3498db;
        }

        .tab.active {
            border-bottom: 2px solid #3498db;
            color: #3498db;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .filters {
                flex-direction: column;
            }

            .table {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2 style="text-align: center; margin-bottom: 30px;">Admin Login</h2>
            <div id="loginError" class="error" style="display: none;"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="dashboard">
            <div class="header">
                <h1>🚗 Ride Admin Dashboard</h1>
                <p>Monitor orders, drivers, and customers in real-time</p>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated here -->
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="orders">📋 Orders</div>
                <div class="tab" data-tab="drivers">🚗 Drivers</div>
                <div class="tab" data-tab="customers">👥 Customers</div>
                <div class="tab" data-tab="stats">📊 Statistics</div>
            </div>

            <!-- Orders Tab -->
            <div id="ordersTab" class="tab-content active">
                <div class="section">
                    <div class="section-title">Recent Orders</div>
                    <button class="btn-refresh" onclick="refreshOrders()">🔄 Refresh</button>
                    
                    <div class="filters">
                        <select id="statusFilter" onchange="refreshOrders()">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="assigned">Assigned</option>
                            <option value="accepted">Accepted</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="table" id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Driver</th>
                                    <th>Status</th>
                                    <th>Pickup</th>
                                    <th>Dropoff</th>
                                    <th>Fare</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr><td colspan="8" style="text-align: center; padding: 20px;">Loading orders...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Drivers Tab -->
            <div id="driversTab" class="tab-content">
                <div class="section">
                    <div class="section-title">Drivers Status</div>
                    <button class="btn-refresh" onclick="refreshDrivers()">🔄 Refresh Drivers</button>
                    
                    <div class="filters">
                        <select id="availabilityFilter" onchange="refreshDrivers()">
                            <option value="">All Drivers</option>
                            <option value="true">Available Only</option>
                            <option value="false">Busy Only</option>
                        </select>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="table" id="driversTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Status</th>
                                    <th>Vehicle</th>
                                    <th>Rating</th>
                                    <th>Deliveries</th>
                                    <th>Current Orders</th>
                                </tr>
                            </thead>
                            <tbody id="driversTableBody">
                                <tr><td colspan="8" style="text-align: center; padding: 20px;">Click refresh to load drivers...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Customers Tab -->
            <div id="customersTab" class="tab-content">
                <div class="section">
                    <div class="section-title">Customers</div>
                    <button class="btn-refresh" onclick="refreshCustomers()">🔄 Refresh</button>

                    <div style="overflow-x: auto;">
                        <table class="table" id="customersTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Total Orders</th>
                                    <th>Joined</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody">
                                <tr><td colspan="5" style="text-align: center; padding: 20px;">Click refresh to load customers...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div id="statsTab" class="tab-content">
                <div class="section">
                    <div class="section-title">System Statistics</div>
                    <button class="btn-refresh" onclick="refreshStats()">🔄 Refresh Stats</button>
                    
                    <div id="detailedStats">
                        <p style="text-align: center; padding: 20px;">Click refresh to load detailed statistics...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3003/api';
        let authToken = '';

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.user.userType !== 'admin') {
                        showError('Admin access required');
                        return;
                    }
                    
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    showDashboard();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Login failed: ' + error.message);
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            loadDashboard();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            authToken = '';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
        }

        // Check for stored token on page load
        window.addEventListener('load', () => {
            const storedToken = localStorage.getItem('adminToken');
            if (storedToken) {
                authToken = storedToken;
                showDashboard();
            }
            // Initialize tab event listeners
            initializeTabs();
        });

        // Dashboard functionality
        async function loadDashboard() {
            try {
                // Load dashboard data with status filter
                const status = document.getElementById('statusFilter').value;
                const dashboardUrl = `${API_BASE}/admin/dashboard${status ? `?status=${status}` : ''}`;
                
                const dashboardResponse = await fetch(dashboardUrl, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                    },
                });

                if (!dashboardResponse.ok) {
                    if (dashboardResponse.status === 403) {
                        alert('Admin access required');
                        logout();
                        return;
                    }
                    throw new Error('Failed to load dashboard');
                }

                const dashboardData = await dashboardResponse.json();
                updateStats(dashboardData.stats);
                updateOrdersTable(dashboardData.orders);

                // Load customers separately
                await loadCustomers();

            } catch (error) {
                console.error('Dashboard load error:', error);
                alert('Failed to load dashboard data');
            }
        }

        async function loadCustomers() {
            try {
                const response = await fetch(`${API_BASE}/admin/customers`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    updateCustomersTable(data.customers);
                }
            } catch (error) {
                console.error('Customers load error:', error);
            }
        }

        async function loadDrivers() {
            try {
                const available = document.getElementById('availabilityFilter').value;
                const url = `${API_BASE}/admin/drivers${available ? `?available=${available}` : ''}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                    },
                });

                if (!response.ok) throw new Error('Failed to load drivers');

                const data = await response.json();
                updateDriversTable(data.drivers);
            } catch (error) {
                console.error('Drivers load error:', error);
                alert('Failed to load drivers data');
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                    },
                });

                if (!response.ok) throw new Error('Failed to load stats');

                const data = await response.json();
                updateDetailedStats(data);
            } catch (error) {
                console.error('Stats load error:', error);
                alert('Failed to load statistics');
            }
        }

        function updateStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalOrders}</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.activeOrders}</div>
                    <div class="stat-label">Active Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.completedOrders}</div>
                    <div class="stat-label">Completed Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.availableDrivers}/${stats.totalDrivers}</div>
                    <div class="stat-label">Available Drivers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.totalCustomers}</div>
                    <div class="stat-label">Total Customers</div>
                </div>
            `;
        }

        function updateOrdersTable(orders) {
            const tbody = document.getElementById('ordersTableBody');
            if (!orders || orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>${order.orderId || 'N/A'}</td>
                    <td>
                        <strong>${order.customerInfo?.name || 'N/A'}</strong><br>
                        <small>${order.customerInfo?.phone || ''}</small>
                    </td>
                    <td>
                        ${order.driverInfo ? `
                            <strong>${order.driverInfo.name}</strong><br>
                            <small>${order.driverInfo.vehicleNumber || ''}</small>
                        ` : '<em>Unassigned</em>'}
                    </td>
                    <td><span class="status-badge status-${order.status}">${order.status.toUpperCase()}</span></td>
                    <td>${order.pickupLocation?.address || 'N/A'}</td>
                    <td>${order.dropoffLocation?.address || 'N/A'}</td>
                    <td>$${order.fare?.totalFare?.toFixed(2) || '0.00'}</td>
                    <td>${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'N/A'}</td>
                </tr>
            `).join('');
        }

        function updateDriversTable(drivers) {
            const tbody = document.getElementById('driversTableBody');
            if (!drivers || drivers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">No drivers found</td></tr>';
                return;
            }

            tbody.innerHTML = drivers.map(driver => `
                <tr>
                    <td><strong>${driver.name || 'N/A'}</strong></td>
                    <td>${driver.email || 'N/A'}</td>
                    <td>${driver.phone || 'N/A'}</td>
                    <td class="${driver.isAvailable ? 'available' : 'unavailable'}">
                        ${driver.isAvailable ? '🟢 Available' : '🔴 Busy'}
                    </td>
                    <td>
                        ${driver.vehicleInfo?.type || 'N/A'}<br>
                        <small>${driver.vehicleInfo?.number || ''}</small>
                    </td>
                    <td>⭐ ${driver.rating?.toFixed(1) || '5.0'}</td>
                    <td>${driver.totalDeliveries || 0}</td>
                    <td>${driver.currentOrders?.length || 0} orders</td>
                </tr>
            `).join('');
        }

        function updateCustomersTable(customers) {
            const tbody = document.getElementById('customersTableBody');
            if (!customers || customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No customers found</td></tr>';
                return;
            }

            tbody.innerHTML = customers.map(customer => `
                <tr>
                    <td><strong>${customer.name || 'N/A'}</strong></td>
                    <td>${customer.email || 'N/A'}</td>
                    <td>${customer.phone || 'N/A'}</td>
                    <td>${customer.totalOrders || 0}</td>
                    <td>${customer.createdAt ? new Date(customer.createdAt).toLocaleDateString() : 'N/A'}</td>
                </tr>
            `).join('');
        }

        function updateDetailedStats(stats) {
            const detailedStatsDiv = document.getElementById('detailedStats');
            detailedStatsDiv.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${stats.orders?.today || 0}</div>
                        <div class="stat-label">Orders Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.orders?.thisWeek || 0}</div>
                        <div class="stat-label">Orders This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.orders?.thisMonth || 0}</div>
                        <div class="stat-label">Orders This Month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">$${stats.revenue?.today?.toFixed(2) || '0.00'}</div>
                        <div class="stat-label">Revenue Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">$${stats.revenue?.thisWeek?.toFixed(2) || '0.00'}</div>
                        <div class="stat-label">Revenue This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">$${stats.revenue?.thisMonth?.toFixed(2) || '0.00'}</div>
                        <div class="stat-label">Revenue This Month</div>
                    </div>
                </div>
                
                <div class="section" style="margin-top: 20px;">
                    <h3>Orders by Status</h3>
                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                        ${Object.entries(stats.ordersByStatus || {}).map(([status, count]) => `
                            <div class="stat-card">
                                <div class="stat-number">${count}</div>
                                <div class="stat-label">${status.charAt(0).toUpperCase() + status.slice(1)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            const tabContent = document.getElementById(tabName + 'Tab');
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            // Add active class to clicked tab
            const clickedTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            
            // Load data based on tab
            if (tabName === 'orders') {
                loadDashboard();
            } else if (tabName === 'drivers') {
                loadDrivers();
            } else if (tabName === 'customers') {
                loadCustomers();
            } else if (tabName === 'stats') {
                loadStats();
            }
        }

        // Add event listeners for tabs
        function initializeTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName);
                });
            });
        }

        // Refresh functions for each section
        async function refreshOrders() {
            showLoading('ordersTableBody');
            try {
                await loadDashboard();
            } catch (error) {
                showError('ordersTableBody', 'Failed to load orders');
            }
        }

        async function refreshDrivers() {
            showLoading('driversTableBody');
            try {
                await loadDrivers();
            } catch (error) {
                showError('driversTableBody', 'Failed to load drivers');
            }
        }

        async function refreshCustomers() {
            showLoading('customersTableBody');
            try {
                await loadCustomers();
            } catch (error) {
                showError('customersTableBody', 'Failed to load customers');
            }
        }

        async function refreshStats() {
            const statsDiv = document.getElementById('detailedStats');
            if (statsDiv) {
                statsDiv.innerHTML = '<p style="text-align: center; padding: 20px;">🔄 Loading statistics...</p>';
            }
            try {
                await loadStats();
            } catch (error) {
                if (statsDiv) {
                    statsDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #e74c3c;">❌ Failed to load statistics</p>';
                }
            }
        }

        // Auto-refresh every 30 seconds, but only for the active tab
        setInterval(() => {
            if (authToken && document.getElementById('dashboardSection').style.display !== 'none') {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    const tabId = activeTab.id;
                    if (tabId === 'ordersTab') {
                        refreshOrders();
                    } else if (tabId === 'driversTab') {
                        refreshDrivers();
                    } else if (tabId === 'customersTab') {
                        refreshCustomers();
                    } else if (tabId === 'statsTab') {
                        refreshStats();
                    }
                }
            }
        }, 30000);

        // Add loading indicators
        function showLoading(tableBodyId) {
            const tbody = document.getElementById(tableBodyId);
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">🔄 Loading...</td></tr>';
            }
        }

        function showError(tableBodyId, message) {
            const tbody = document.getElementById(tableBodyId);
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px; color: #e74c3c;">❌ Error: ${message}</td></tr>`;
            }
        }
    </script>
</body>
</html>
